{
	"name": "_capValues",
	"properties": {
		"type": "Flowlet",
		"typeProperties": {
			"sources": [],
			"sinks": [],
			"transformations": [
				{
					"name": "SplitModelTypes"
				},
				{
					"name": "DeriveGenderColumns"
				},
				{
					"name": "DeriveModelColumns"
				},
				{
					"name": "AddModelTotalToGender"
				},
				{
					"name": "AggregateGenderData"
				},
				{
					"name": "DeriveEngineColumns"
				},
				{
					"name": "union"
				},
				{
					"name": "input"
				},
				{
					"name": "output"
				}
			],
			"scriptLines": [
				"parameters{",
				"     market as string,",
				"     year as string",
				"}",
				"input(output(",
				"          GroupName as string,",
				"          GroupType as string,",
				"          value1 as double,",
				"          value2 as double,",
				"          value3 as double,",
				"          value4 as double,",
				"          value5 as double",
				"     ),",
				"     order: 0,",
				"     allowSchemaDrift: true) ~> input",
				"input split(GroupType == 'Model/Gender',",
				"     GroupType == 'Model/Engine' || GroupType == 'Model/Body',",
				"     GroupType == 'Model',",
				"     disjoint: false) ~> SplitModelTypes@(ModelGender, ModelEngine, Model)",
				"SplitModelTypes@ModelGender derive(market = $market,",
				"          year = $year,",
				"          model = iif(GroupName == 'Porsche/Female' || GroupName == 'Porsche/Male', 'All Models',",
				"      iif(locate(' ', split(GroupName, '/')[1]) > 0,",
				"        concat(",
				"           trim(split(split(GroupName, '/')[1], ' ')[1]),",
				"           ' All ',",
				"           trim(substring(split(GroupName, '/')[1], locate(' ', split(GroupName, '/')[1]) + 1, 100))",
				"        ),",
				"        concat(split(GroupName, '/')[1], ' All')",
				"      )",
				"    ),",
				"          value1_male = iif(endsWith(GroupName, '/Male'), value1, toDouble(0)),",
				"          value1_female = iif(endsWith(GroupName, '/Female'), value1, toDouble(0)),",
				"          value2_male = iif(endsWith(GroupName, '/Male'), value2, toDouble(0)),",
				"          value2_female = iif(endsWith(GroupName, '/Female'), value2, toDouble(0)),",
				"          value3_male = iif(endsWith(GroupName, '/Male'), value3, toDouble(0)),",
				"          value3_female = iif(endsWith(GroupName, '/Female'), value3, toDouble(0)),",
				"          value4_male = iif(endsWith(GroupName, '/Male'), value4, toDouble(0)),",
				"          value4_female = iif(endsWith(GroupName, '/Female'), value4, toDouble(0)),",
				"          value5_male = iif(endsWith(GroupName, '/Male'), value5, toDouble(0)),",
				"          value5_female = iif(endsWith(GroupName, '/Female'), value5, toDouble(0))) ~> DeriveGenderColumns",
				"SplitModelTypes@Model derive(ModelName = iif(GroupName == 'Porsche', 'All Models',",
				"      iif(locate(' ', GroupName) > 0,",
				"        concat(",
				"           trim(split(GroupName, ' ')[1]),",
				"           ' All ',",
				"           trim(substring(GroupName, locate(' ', GroupName) + 1, 100))",
				"        ),",
				"        concat(GroupName, ' All')",
				"      )",
				"    ),",
				"          value1_total = value1,",
				"          value2_total = value2,",
				"          value3_total = value3,",
				"          value4_total = value4,",
				"          value5_total = value5) ~> DeriveModelColumns",
				"DeriveGenderColumns, DeriveModelColumns lookup(model == ModelName,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'auto')~> AddModelTotalToGender",
				"AddModelTotalToGender aggregate(groupBy(market,",
				"          year,",
				"          model),",
				"     value1_male = max(value1_male),",
				"          value1_female = max(value1_female),",
				"          value1_total = max(value1_total),",
				"          value2_male = max(value2_male),",
				"          value2_female = max(value2_female),",
				"          value2_total = max(value2_total),",
				"          value3_male = max(value3_male),",
				"          value3_female = max(value3_female),",
				"          value3_total = max(value3_total),",
				"          value4_male = max(value4_male),",
				"          value4_female = max(value4_female),",
				"          value4_total = max(value4_total),",
				"          value5_male = max(value5_male),",
				"          value5_female = max(value5_female),",
				"          value5_total = max(value5_total)) ~> AggregateGenderData",
				"SplitModelTypes@ModelEngine derive(market = $market,",
				"          year = $year,",
				"          model = replace(GroupName, '/', ' '),",
				"          value1_total = value1,",
				"          value2_total = value2,",
				"          value3_total = value3,",
				"          value4_total = value4,",
				"          value5_total = value5) ~> DeriveEngineColumns",
				"AggregateGenderData, DeriveEngineColumns union(byName: true)~> union",
				"union output() ~> output"
			]
		}
	}
}